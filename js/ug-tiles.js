function UGTiles(){var e,t,i,n,l,r=this,a=jQuery(this),o=new UniteGalleryMain,s=new UGFunctions,d=new UGTileDesign,h=new UGThumbsGeneral,u={},c={tiles_type:"columns",tiles_col_width:250,tiles_align:"center",tiles_exact_width:!1,tiles_space_between_cols:3,tiles_space_between_cols_mobile:3,tiles_include_padding:!0,tiles_min_columns:2,tiles_max_columns:0,tiles_keep_order:!1,tiles_set_initial_height:!0,tiles_justified_row_height:150,tiles_justified_space_between:3,tiles_nested_optimal_tile_width:250,tiles_nested_col_width:null,tiles_nested_debug:!1,tiles_enable_transition:!0};this.events={THUMB_SIZE_CHANGE:"thumb_size_change",TILES_FIRST_PLACED:"tiles_first_placed",ALL_TILES_LOADED:"all_tiles_loaded"};var m={isFirstTimeRun:!0,handle:null,isTransActive:!1,isTransInited:!1,isFirstPlaced:!0,isAllLoaded:!1},g={colWidth:null,nestedOptimalCols:5,gridY:0,maxColumns:0,columnsValueToEnableHeightResize:3,resizeLeftRightToColumn:!0,currentItem:0,currentGap:null,optimalTileWidth:null,maxGridY:0};function f(i,n){g_objects=i.getObjects(),o=i,e=jQuery(i),t=g_objects.g_objWrapper,g_objects.g_arrItems,c=jQuery.extend(c,n),function(){c.tiles_min_columns<1&&(c.tiles_min_columns=1);0!=c.tiles_max_columns&&c.tiles_max_columns<c.tiles_min_columns&&(c.tiles_max_columns=c.tiles_min_columns)}(),d.init(i,c),h=d.getObjThumbs()}function _(){if(i.addClass("ug-tiles-rest-mode"),m.isTransInited=!0,1==c.tiles_enable_transition){i.addClass("ug-tiles-transit");var e=d.getOptions();1==e.tile_enable_image_effect&&0==e.tile_image_effect_reverse&&i.addClass("ug-tiles-transit-overlays"),m.isTransActive=!0}}function v(){return s.getElementSize(i).width}function p(){return 0!=m.isTransInited&&(i.addClass("ug-tiles-transition-active"),i.removeClass("ug-tiles-rest-mode"),0!=m.isTransActive&&void d.disableEvents())}function W(){if(0==m.isTransInited)return!1;i.removeClass("ug-tiles-transition-active"),i.addClass("ug-tiles-rest-mode")}function T(){1==m.isTransActive?(setTimeout((function(){d.enableEvents(),d.triggerSizeChangeEventAllTiles(),W()}),800),m.handle&&clearTimeout(m.handle),m.handle=setTimeout((function(){W(),d.triggerSizeChangeEventAllTiles(),m.handle=null}),2e3)):(d.triggerSizeChangeEventAllTiles(),W())}function C(){u.colWidth=(u.availWidth-u.colGap*(u.numCols-1))/u.numCols,u.colWidth=Math.floor(u.colWidth),u.totalWidth=s.getSpaceByNumItems(u.numCols,u.colWidth,u.colGap)}function H(){if(u.colWidth=c.tiles_col_width,u.minCols=c.tiles_min_columns,u.maxCols=c.tiles_max_columns,0==o.isMobileMode()?u.colGap=c.tiles_space_between_cols:u.colGap=c.tiles_space_between_cols_mobile,u.galleryWidth=v(),u.availWidth=u.galleryWidth,1==c.tiles_include_padding&&(u.availWidth=u.galleryWidth-2*u.colGap),1==c.tiles_exact_width)u.numCols=s.getNumItemsInSpace(u.availWidth,u.colWidth,u.colGap),u.maxCols>0&&u.numCols>u.maxCols&&(u.numCols=u.maxCols),u.numCols<u.minCols?(u.numCols=u.minCols,C()):u.totalWidth=u.numCols*(u.colWidth+u.colGap)-u.colGap;else{var e=s.getNumItemsInSpaceRound(u.availWidth,u.colWidth,u.colGap);e<u.minCols?e=u.minCols:0!=u.maxCols&&e>u.maxCols&&(e=u.maxCols),u.numCols=e,C()}switch(c.tiles_align){case"center":default:u.addX=Math.round((u.galleryWidth-u.totalWidth)/2);break;case"left":u.addX=0;break;case"right":u.addX=u.galleryWidth-u.totalWidth}for(u.arrPosx=[],col=0;col<u.numCols;col++){var t=s.getColX(col,u.colWidth,u.colGap);u.arrPosx[col]=t+u.addX}}function I(){u.maxColHeight=0,u.colHeights=[0]}function b(e,t,n,l){if(null==l)l=function(){var e=0,t=999999999;for(col=0;col<u.numCols;col++){if(null==u.colHeights[col]||0==u.colHeights[col])return col;u.colHeights[col]<t&&(e=col,t=u.colHeights[col])}return e}();var r=0;void 0!==u.colHeights[l]&&(r=u.colHeights[l]);var a=d.getTileHeightByWidth(u.colWidth,e);if(null===a){if(1==c.tiles_enable_transition)throw new Error("Can't know tile height, please turn off transition");a=s.getElementSize(e).height}var o=u.arrPosx[l];s.placeElement(e,o,r);var h=r+a;u.colHeights[l]=h+u.colGap,u.maxColHeight<h&&(u.maxColHeight=h),1==t&&e.show().fadeTo(0,1),1==n&&i.height(u.maxColHeight)}function E(e){e||(e=!1),H(),I();var t=h.getThumbs(h.type.GET_THUMBS_RATIO);p(),d.resizeAllTiles(u.colWidth,d.resizemode.VISIBLE_ELEMENTS,t);for(var n=0;n<t.length;n++){var l=jQuery(t[n]),r=void 0;1==c.tiles_keep_order&&(r=s.getColByIndex(u.numCols,n)),b(l,e,!1,r)}T();var a=i.height();1==m.isTransActive&&a>u.maxColHeight?setTimeout((function(){i.height(u.maxColHeight)}),700):i.height(u.maxColHeight)}function w(e,t){if(!0!==t&&0==function(e){var t=e.index();if(!0===o.getItem(t).ordered_placed)return!1;var i=s.getPrevRowSameColIndex(t,u.numCols);return i<0||!0===o.getItem(i).ordered_placed}(e))return!1;var i=e.index(),n=s.getColByIndex(u.numCols,i),l=o.getItem(i);d.resizeTile(e,u.colWidth),b(e,!0,!0,n),l.ordered_placed=!0;var r=o.getNumItems(),a=s.getNextRowSameColIndex(i,u.numCols);if(a>=r)return!1;var c=h.getThumbByIndex(a),m=o.getItem(a);h.isThumbLoaded(c);h.isThumbLoaded(c)&&!m.ordered_placed&&w(c,!0)}function y(){var e=h.getThumbs(h.type.GET_THUMBS_NO_RATIO);if(!e||0==e.length)return!1;if(m.isAllLoaded=!1,1==m.isFirstPlaced){H(),I();var t=Math.abs(u.galleryWidth-u.totalWidth);if(1==c.tiles_set_initial_height&&0==s.isScrollbarExists()&&t<25){e.length;var n=Math.ceil(e.length/u.numCols)*c.tiles_col_width*.75;i.height(n),H()}}e.fadeTo(0,0);var l=e.find("img.ug-thumb-image"),g=u.numCols,f=u.galleryWidth;s.checkImagesLoaded(l,(function(){H(),g==u.numCols&&f==u.galleryWidth||E(!1),_(),a.trigger(r.events.ALL_TILES_LOADED)}),(function(e,t){1==m.isFirstPlaced&&o.triggerEvent(r.events.TILES_FIRST_PLACED),function(e,t){if(1==t)return!1;e=jQuery(e);var i=jQuery(e).parent();h.triggerImageLoadedEvent(i,e),1==c.tiles_keep_order?w(i):(d.resizeTile(i,u.colWidth),b(i,!0,!0))}(e,t)}))}function x(){var e=v(),t=h.getThumbs(!0),i=c.tiles_justified_row_height,n=[],l=0,r=c.tiles_justified_space_between,a=t.length;jQuery.each(t,(function(e,t){t=jQuery(t);var r=h.getItemByThumb(t),a=r.thumbWidth;r.thumbHeight!==i&&(a=Math.floor(r.thumbRatioByWidth*i)),n[e]=a,l+=a}));var o=Math.ceil(l/e);o>a&&(o=a);var s=l/o,d=[],u=0,m=[],g=[],f=0,_=0;jQuery.each(t,(function(e,t){var i=n[e];f+i/2>(_+1)*s&&(m[d.length]=u,d.push(g),g=[],u=0,_++),f+=i,u+=i,g.push(t)})),m[d.length]=u,d.push(g);var p=[],W=[],T=0;return jQuery.each(d,(function(t,l){l.length;var a=m[t],o=(l.length-1)*r,s=(e-o)/a,d=Math.round(i*s);T+=d,t>0&&(T+=r),W.push(d);var h=d/i,u=[],c=o;jQuery.each(l,(function(e,t){var i=jQuery(t).index(),l=n[i],r=Math.round(l*h);u[e]=r,c+=r}));var g=c-e;jQuery.each(u,(function(e,t){if(0==g)return!1;g<0?(u[e]=t+1,g++):(u[e]=t-1,g--),e==u.length-1&&0!=g&&(u[e]-=g)})),p[t]=u})),{arrRows:d,arrRowWidths:p,arrRowHeights:W,gap:r,totalHeight:T}}function L(e){if(!e)e=!1;var t=v(),n=x();i.height(n.totalHeight),v()!=t&&(n=x()),p();var l=0,r=0;jQuery.each(n.arrRows,(function(t,i){var a=n.arrRowWidths[t],o=n.arrRowHeights[t],h=0;jQuery.each(i,(function(t,i){var u=jQuery(i),c=o,m=a[t];d.resizeTile(u,m,c,d.resizemode.VISIBLE_ELEMENTS),s.placeElement(u,h,l),(h+=m)>r&&(r=h),h+=n.gap,1==e&&jQuery(i).show()})),l+=o+n.gap})),T()}function j(){var e=v();switch(g.galleryWidth=e,n={},g.colWidth=c.tiles_nested_col_width,g.optimalTileWidth=c.tiles_nested_optimal_tile_width,g.currentGap=c.tiles_space_between_cols,1==o.isMobileMode()&&(g.currentGap=c.tiles_space_between_cols_mobile),null==g.colWidth?g.colWidth=Math.floor(g.optimalTileWidth/g.nestedOptimalCols):g.optimalTileWidth>g.colWidth?g.nestedOptimalCols=Math.ceil(g.optimalTileWidth/g.colWidth):g.nestedOptimalCols=1,g.maxColumns=s.getNumItemsInSpace(e,g.colWidth,g.currentGap),g.colWidth=s.getItemSizeInSpace(e,g.maxColumns,g.currentGap),g.gridY=0,l=[],h.getThumbs(!0).each((function(){var e=function(e){var t,i,n={},l=g.colWidth,r=g.currentGap,a=d.getTileImageSize(e),o=e.index(),s=Math.ceil(function(e){return Math.abs(Math.sin(Math.abs(1e3*Math.sin(e))))}(o)*(1*g.nestedOptimalCols/3)+2*g.nestedOptimalCols/3),h=a.width,u=a.height,c=h/u;h>u?(t=s,0==(i=Math.round(t/c))&&(i=1)):(i=s,0==(t=Math.round(i*c))&&(t=1));return n.dimWidth=t,n.dimHeight=i,n.width=t*l+r*(t-1),n.height=i*l+r*(i-1),n.imgWidth=h,n.imgHeight=u,n.left=0,n.top=0,n}(jQuery(this));l.push(e)})),g.optimalTileWidth>g.colWidth?g.nestedOptimalCols=Math.ceil(g.optimalTileWidth/g.colWidth):g.nestedOptimalCols=1,g.totalWidth=g.maxColumns*(g.colWidth+g.currentGap)-g.currentGap,c.tiles_align){case"center":default:g.addX=Math.round((g.galleryWidth-g.totalWidth)/2);break;case"left":g.addX=0;break;case"right":g.addX=g.galleryWidth-g.totalWidth}g.maxGridY=0}function M(e){var t=v();j(),S();var n=g.maxGridY*(g.colWidth+g.currentGap)-g.currentGap;i.height(n),v()!=t&&(j(),S()),0==c.tiles_nested_debug&&function(e){if(!e)e=!1;p();for(var t=0;t<l.length;t++)V(t,e);i.height(g.maxColHeight),T()}(e)}function S(e){if(1==c.tiles_nested_debug)return void 0===e&&(e=!0),function(e,t){if(0==t){for(var i=g.currentItem;i<l.length;i++)G(i,!0);g.currentItem=l.length-1}else G(g.currentItem,!0);for(i=0;i<=g.currentItem;i++)V(i,!0);g.currentItem++}(0,e),!1;for(var t=0;t<l.length;t++)G(t,!0)}function G(e,t){if(!t)t=!1;g.maxColHeight=0;for(var i=s.getObjectLength(n),l=g.gridY;l<=i+1;l++){for(var r=0;r<g.maxColumns;r++){if(0==k(g.gridY)||0==N(g.gridY,r))return void A(e,O(r),r)}g.gridY++}}function A(e,t,i){var r=jQuery.extend(!0,{},l[e]),a=r.dimWidth,o=t-r.dimWidth,s=g.nestedOptimalCols;if(t<=r.dimWidth||o<=.33*s||t<=s)Q(e,t);else if(o<=s)s>=4?1==D(Math.floor(t/2),i)?Q(e,Math.floor(t/2)+1):Q(e,Math.floor(t/2)):Q(objImage,t);else if(1==D(a,i))switch(a>=s){case!0:Q(e,a-1);break;case!1:Q(e,a+1)}var d=function(e,t,i){var l=g.gridY-1,r=0,a=0,o=1,s=[],d=[];if(s.push(e),l>=0){for(a=0;l>=0;){if(r=n[l][i],void 0!==n[l][i-1]&&n[l][i-1]==n[l][i]||void 0!==n[l][i+t]&&n[l][i+t-1]==n[l][i+t]||n[l][i]!=n[l][i+t-1])return d.push(o),d.push(s),d;a!=r&&(o++,s.push(r)),l--,a=r}return d.push(o),d.push(s),d}return[0,[]]}(e,(r=jQuery.extend(!0,{},l[e])).dimWidth,i);if(g.columnsValueToEnableHeightResize<=d[0]&&g.maxColumns>=2*g.nestedOptimalCols){var h=function(e,t){var i=0,l=0,r=t.dimWidth,a=t.dimHeight,o=0,s=0,d=jQuery.map(n,(function(e,t){return[e]}));if(void 0===d[g.gridY]||void 0===d[g.gridY][e-1])l=0;else for(var h=0;void 0!==n[g.gridY+h]&&-1!=n[g.gridY+h][e-1];)o=n[g.gridY+h][e-2],h++,l++;if(void 0===d[g.gridY]||void 0===d[g.gridY][e+r])i=0;else for(h=0;void 0!==n[g.gridY+h]&&-1!=n[g.gridY+h][e+r];)s=n[g.gridY+h][e+r+1],h++,i++;var u=0,c=0;Math.abs(a-l)<Math.abs(a-i)&&0!=l?(u=l,c=o):0!=i?(u=i,c=s):u=a;return{newHeight:u,idToResize:c}}(i,r),u=R(e,h.newHeight,!0);l[e].dimHeight=u.dimHeight;var c=function(e,t){for(var i=0,n=0,r=[],a=0,o=0,s=0;s<e[1].length;s++){var d=e[1][s],h=l[e[1][s]];if(n+=h.dimHeight,0!=s)i+=h.dimHeight,r.push([d,h.dimHeight]);else{var u=Q(d,t,!0);i+=u.dimHeight,r.push([e[1][s],u.dimHeight])}}a=h.left,o=h.top;var c=n,m=[];for(s=r.length-1;s>=0;s--){var g;d=r[s][0];0!=s?(c-=g=Math.max(Math.round(1*n/3),Math.floor(r[s][1]*(n/i))),(u=R(d,g,!0)).left=a,u.top=o,m.push({tileID:d,sizes:u}),o+=u.dimHeight):((u=R(d,g=c,!0)).left=a,u.top=o,m.push({tileID:d,sizes:u}))}return m}(d,u.dimWidth),m=!1;(function(e){for(var t=0,i=0,l=0;l<e.length-1;l++){var r=-1,a=-1;k((o=e[l].sizes).top+o.dimHeight)&&g.maxColumns>o.left+o.dimWidth&&(r=n[o.top+o.dimHeight-1][o.left+o.dimWidth],a=n[o.top+o.dimHeight][o.left+o.dimWidth]),r!=a&&t++}for(l=0;l<e.length-1;l++){var o;r=-1,a=-1;k((o=e[l].sizes).top+o.dimHeight)&&o.left-1>=0&&(r=n[o.top+o.dimHeight-1][o.left-1],a=n[o.top+o.dimHeight][o.left-1]),r!=a&&i++}return Math.max(i,t)})(c)>=2&&(m=!0),h.newHeight>=r.dimHeight&&(r=R(e,h.newHeight,!0));var f=function(e,t,i){var n=l[e],r=n.dimHeight,a=(n.dimWidth,n.left),o=n.top,s=(parseInt(o/(g.colWidth+g.currentGap)),parseInt(a/(g.colWidth+g.currentGap)),R(e,r-t+i,!0)),d=[];return d.push({tileID:e,sizes:s}),d}(h.idToResize,h.newHeight,r.dimHeight);return r.top=g.gridY,r.left=i,f.push({tileID:e,sizes:r}),Y(f)<Y(c)||1==m?void z(f):void z(c)}r.left=i,r.top=g.gridY,l[e]=r,F(e,r,i,g.gridY),g.maxGridY=r.top+r.dimHeight}function z(e){for(var t=0;t<e.length;t++){var i=e[t].sizes,n=e[t].tileID;l[n]=jQuery.extend(!0,{},i),F(n,i,i.left,i.top)}}function Q(e,t,i){i||(i=!1);var n=g.colWidth,r=g.currentGap,a=l[e],o=a.imgWidth/a.imgHeight;if(dimWidth=t,dimHeight=Math.round(dimWidth/o),1==i){var s=jQuery.extend(!0,{},a);return s.dimWidth=dimWidth,s.dimHeight=dimHeight,s.width=dimWidth*n+r*(dimWidth-1),s.height=dimHeight*n+r*(dimHeight-1),s}a.dimWidth=dimWidth,a.dimHeight=dimHeight,a.width=dimWidth*n+r*(dimWidth-1),a.height=dimHeight*n+r*(dimHeight-1)}function R(e,t,i){i||(i=!1);var n=l[e],r=n.dimWidth,a=g.colWidth,o=g.currentGap;if(1==i){var s=jQuery.extend(!0,{},n);return s.dimHeight=t,s.width=r*a+o*(r-1),s.height=t*a+o*(t-1),s}n.dimHeight=t,n.width=r*a+o*(r-1),n.height=t*a+o*(t-1)}function Y(e){for(var t=0,i=0,n=0;n<e.length;n++){var r=l[e[n].tileID];if(0==r.dimHeight||0==r.height)return;resizeVal=r.dimWidth/r.dimHeight/(r.imgWidth/r.imgHeight),resizeVal<1&&(resizeVal=1/resizeVal),t+=resizeVal,i++}return t/i}function D(e,t){var i=g.gridY-1;return!(i<=0||0==k(i))&&n[i][t+e-1]!=n[i][t+e]}function O(e){var t=e,i=0;if(1==k(g.gridY))for(;0==N(g.gridY,t);)i++,t++;else i=g.maxColumns;return i}function k(e){return void 0!==n[e]}function F(e,t,i,n){for(var l=0;l<t.dimHeight;l++)for(var r=0;r<t.dimWidth;r++)0==k(n+l)&&B(n+l),P(n+l,i+r,e)}function B(e){n[e]=new Object;for(var t=0;t<g.maxColumns;t++)n[e][t]=-1}function N(e,t){return-1!=n[e][t]}function P(e,t,i){n[e][t]=i}function V(e,t){var i=h.getThumbByIndex(e),n=l[e],r=n.top*(g.colWidth+g.currentGap),a=g.addX+n.left*(g.colWidth+g.currentGap);d.resizeTile(i,n.width,n.height,d.resizemode.VISIBLE_ELEMENTS),s.placeElement(i,a,r),r+n.height>g.maxColHeight&&(g.maxColHeight=r+n.height),1==t&&i.fadeTo(0,1)}function X(){if(1==m.isFirstTimeRun)return!0;if(0==m.isAllLoaded)return!1;switch(c.tiles_type){case"columns":E(!1);break;case"justified":L(!1);break;case"nested":1==o.isMobileMode()?E(!1):M(!1)}}function U(){switch(t.children(".ug-tile").show(),1==m.isFirstTimeRun&&(a.on(r.events.ALL_TILES_LOADED,(function(){m.isAllLoaded=!0})),e.on(o.events.SIZE_CHANGE,X),e.on(r.events.TILES_FIRST_PLACED,(function(){m.isFirstPlaced=!1})),d.initEvents()),d.run(),c.tiles_type){default:case"columns":y();break;case"justified":i=jQuery(t).find("img.ug-thumb-image"),n=h.getThumbs(),m.isAllLoaded=!1,n.fadeTo(0,0),s.checkImagesLoaded(i,(function(){setTimeout((function(){L(!0),n.fadeTo(0,1),o.triggerEvent(r.events.TILES_FIRST_PLACED),_(),a.trigger(r.events.ALL_TILES_LOADED)}))}),(function(e,t){e=jQuery(e);var i=jQuery(e).parent();h.triggerImageLoadedEvent(i,e)}));break;case"nested":!function(){var e=jQuery(t).find("img.ug-thumb-image"),i=h.getThumbs();m.isAllLoaded=!1,i.fadeTo(0,0),s.checkImagesLoaded(e,(function(){1==o.isMobileMode()?E(!0):M(!0),o.triggerEvent(r.events.TILES_FIRST_PLACED),_(),a.trigger(r.events.ALL_TILES_LOADED)}),(function(e,t){e=jQuery(e);var i=jQuery(e).parent();h.triggerImageLoadedEvent(i,e)}))}()}var i,n;m.isFirstTimeRun=!1}this.destroy=function(){e.off(o.events.SIZE_CHANGE),d.destroy(),e.off(r.events.TILES_FIRST_PLACED)},this.init=function(e,t){f(e,t)},this.setHtml=function(e){!function(e){e||(e=i||t);i=e;var n=c.tiles_type;e.addClass("ug-tiletype-"+n),d.setHtml(e),e.children(".ug-thumb-wrapper").hide()}(e)},this.getObjTileDesign=function(){return d},this.run=function(){U()},this.runNewItems=function(){if(!i)throw new Error("Can't run new items - parent not set");switch(d.setHtml(i,!0),d.run(!0),c.tiles_type){case"columns":y();break;default:case"justified":case"nested":throw new Error("Tiles type: "+c.tiles_type+" not support load more yet")}}}